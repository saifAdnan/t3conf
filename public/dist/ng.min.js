function getValues(a){var b=[];for(var c in a)if(a.hasOwnProperty(c)){var d={name:c,sip_name:a[c].sip_name,sip:a[c].sip,users:a[c].users};b.push(d)}return b}function chatController(a,b,c,d,e,f){var g=e.name;a.username=USERNAME,a.moderator=null,a.conf_name=null,a.conf_sip=g,a.msgErr=!1,a.enableChat=!0,a.users=null,a.private=!1,a.to=null,a.isAdmin="admin"===ROLE?!0:!1,d.on("user:join",function(c){console.log("user join",c),a.rooms=getValues(c),b.inCall=!0;for(var d=0;d<a.rooms.length;d++)if(a.rooms[d].name===e.name){a.users=a.rooms[d].users;for(var f=0;f<a.rooms[d].users.length;f++)a.rooms[d].users[f].username===USERNAME&&(b.inCall=!0)}}),d.on("user:leave",function(b){a.rooms=getValues(b);for(var c=0;c<a.rooms.length;c++)a.rooms[c].name===e.name&&(a.users=a.rooms[c].users)}),c.get("/users").success(function(b){return b?void(a.moderator=MODERATOR):!1}),d.chatEmit("init",{username:USERNAME}),d.chatOn("send:message",g,function(b){console.warn(b);var c;c=b.private;var b={from:b.from,text:b.text};c&&(b.me="active"),a.messages.push(b);var d=$(".messages-container").height();setTimeout(function(){$("#messages").scrollTo(d)},10)}),d.chatOn("user:join",function(b){if(void 0===b.name)return!1;a.messages.push({from:"CONFERENCE ROOM",text:"User "+b.name+" has joined."});var c=$(".messages-container").height();setTimeout(function(){$("#messages").scrollTo(c)},10)}),d.chatOn("chat:user:left",function(b){if(void 0===b.name)return!1;a.messages.push({from:"CONFERENCE ROOM",text:"User "+b.name+" has left."});var c=$(".messages-container").height();setTimeout(function(){$("#messages").scrollTo(c)},10)}),a.mention=function(b){a.private=!0,a.to=b,setTimeout(function(){$("#message").css({"padding-left":$("#user-tag").width()+10}).focus()},10)},a.clearPrivate=function(){a.private=!1,$("#message").css({"padding-left":12}).focus()},a.messages=[],d.chatOn("kick:user",g,function(){f.url("/")}),a.kick=function(b,c){console.log(b,a.users,"username"),d.chatEmit("kick",{username:b,channel:c},g)},a.sendMessage=function(){if(""===a.message||!a.message)return a.msgErr=!0,a.$apply(),!1;a.msgErr=!1,d.chatEmit("send:message",{message:a.message,roomName:g,"private":a.private,from:USERNAME,to:a.to},g);var b={from:USERNAME,text:a.message,local:!0};a.private&&(b.private=!0,b.to=a.to),a.messages.push(b),a.message="";var c=$(".messages-container").height();setTimeout(function(){$("#messages").scrollTo(c)},10),a.private=!1,$("#message").css({"padding-left":12}).focus()}}function conferenceController(a,b,c,d,e,f){a.users=[],a.selectedUsers=[],a.conf_name=null,a.conf_sip=f.name,b.inConference=!0,c.get("/users").success(function(b){a.users=b.users}),d.on("user:left",function(a){$("#"+a.socketid).parent().remove()}),d.on("change:broadcaster",function(){d.emit("change:broadcaster",{socket:d.socketId()})}),d.emit("new-channel",{channel:f.name,sender:USERNAME}),a.sipSendDTMF=function(a){e.sipSendDTMF(a)},e.sipCall(f.name,function(a){a||setTimeout(function(){e.sipCall(f.name)},2e3)}),a.closeKeyPad=function(){$("#keypad").length&&$("#keypad").modal("hide")},a.closeInvite=function(){$("#invite").length&&$("#invite").modal("hide")},a.invite=function(b){return b.preventDefault(),d.emit("invite",{users:a.selectedUsers,extension:f.name,conf_name:a.conf_name}),$("#invite").modal("hide"),!1}}function dashboardController(a,b){"use strict";a.new=!1,a.users=[],a.userToEdit={},a.title="Edit User",a.unapproved=!1,a.maxSize=10,a.totalUsers=0,a.limit=10,a.currentPage=0,a.search=null,a.showUnapproved=function(){b.get("/users",{params:{unapproved:!a.unapproved}}).success(function(b){if(b.users){for(var c=0;c<b.users.length;c++)b.users[c].reg_date=moment.unix(b.users[c].reg_date).format("MMMM D, YYYY H:m");a.users=b.users,a.totalUsers=b.total}})},b.get("/users",{params:{from:a.currentPage,limit:10}}).success(function(b){if(b.users){for(var c=0;c<b.users.length;c++)b.users[c].reg_date=moment.unix(b.users[c].reg_date).format("MMMM D, YYYY H:m");a.users=b.users,a.totalUsers=b.total}}),a.pageChanged=function(){b.get("/users",{params:{from:a.currentPage-1,limit:a.limit,search:a.search,unapproved:a.unapproved}}).success(function(b){for(var c=0;c<b.users.length;c++)b.users[c].reg_date=moment.unix(b.users[c].reg_date).format("MMMM D, YYYY H:m");a.users=b.users,a.totalUsers=b.total})},a.findUser=function(c){return c.preventDefault(),a.currentPage=0,b.get("/users",{params:{from:a.currentPage,limit:a.limit,search:a.search}}).success(function(b){for(var c=0;c<b.users.length;c++)b.users[c].reg_date=moment.unix(b.users[c].reg_date).format("MMMM D, YYYY H:m");a.users=b.users,a.totalUsers=b.total}),!1},a.deleteUser=function(c,d){if(!confirm("Are you sure you want to delete "+d+"?"))return!1;for(var e=0;e<a.users.length;e++)if(a.users[e]._id===c){a.users.splice(e,1),b.post("/action/removeUser",{id:c}).success(function(){alert("User "+d+" has been deleted!")});break}},a.editUser=function(b){for(var c=0;c<a.users.length;c++)if(a.users[c]._id===b){a.userToEdit=a.users[c];break}$("#edit").modal()},a.updateUser=function(c){for(var d=0;d<a.users.length;d++)if(a.users[d]._id===c){b.post("/users",{id:c,moderator:a.users[d].moderator,approved:a.users[d].approved});break}},a.updateSubmit=function(c){return c.preventDefault(),a.new?(a.userToEdit.reg_date=new Date,b.post("/user/new",a.userToEdit).success(function(c){return"string"==typeof c&&"ok"!==c?(a.err=c,!1):(b.get("/users").success(function(b){for(var c=0;c<b.length;c++)b[c].reg_date=moment.unix(b[c].reg_date).format("MMMM D, YYYY H:m");a.users=b}),alert("User has been successfully added."),$("#edit").modal("hide"),void 0)})):b.post("/user/update",a.userToEdit).success(function(b){return"string"==typeof b&&""!==b?(a.err=b,!1):(alert("User has been successfully updated."),void $("#edit").modal("hide"))}),!1},a.newUser=function(){a.userToEdit={},a.title="New user",a.new=!0,$("#edit").modal(),setTimeout(function(){$("#edit").find("#username").focus()},100)},$("#edit").on("hidden.bs.modal",function(){a.err=null}),a.closeEdit=function(){a.new=!1,a.title="Edit User",$("#edit").modal("hide")}}function mainController(a,b,c,d,e,f,g){function h(b){a.no_files_message=b.length?!1:!0;for(var c=0;c<b.length;c++){var d=new Date(1e3*b[c].date);b[c].time=d.getHours()+":"+d.getMinutes(),d=d.getDate()+"/"+(d.getMonth()+1)+"/"+d.getFullYear()+"-"+d.getHours()+"_"+d.getMinutes(),b[c].ui_date=d,b[c].i_name=b[c].name+"-"+d}a.files=b}f.inCall=!1,a.rooms=null,a.roomNumber=null,a.isExist=!1,a.t3leadsActive=!1,a.isMuted=!1,a.filename=null,a.n_filename=null,a.n_filename_date=null,a.isAdmin="admin"===f.role?!0:!1,f.inConference=!1,a.goToDashBoard=function(){c.url("/dashboard/users")},a.dateStart=moment(new Date).subtract("days",1).unix(),a.dateEnd=moment(new Date).unix(),g(function(){b.get("/conferences").success(function(b){a.rooms=getValues(b)})},100),b.post("/action/getFiles",{start:a.dateStart,end:a.dateEnd}).success(function(a){h(a)}),d.on("user:join",function(b){a.rooms=getValues(b)}),d.on("user:leave",function(b){a.rooms=getValues(b)}),a.join=function(a){c.url("/conference/"+a)},a.mute=function(){e.sipSendDTMF("1"),a.isMuted=!a.isMuted},a.sipHangUp=function(){e.sipHangUp()},a.sipCall=function(a){e.sipCall(a)},a.rename=function(b,c){a.filename=c.name,a.n_filename=c.name.replace("-",""),a.n_filename_date=c.date,$("#rename").modal().find("input").focus()},a.closeRenameM=function(){$("#rename").modal("hide")},a.changeFilename=function(c){return c.preventDefault(),b.post("/action/renameRecord",{filename:a.filename,date:a.n_filename_date,n_filename:a.n_filename}).success(function(){window.location.reload()}),!1},a.toggleKeypad=function(){var a=$("#keypad");a.length&&a.modal()},a.hangUp=function(){e.sipHangUp(),c.url("/")},a.invite=function(){var a=$("#invite");a.length&&a.modal()},a.createConference=function(d){return d.preventDefault(),void 0===a.conf_name?(a.nameImportant=!0,$("#conf_name").focus(),!1):(void 0===a.conf_sip&&a.generateSipNumber(),void 0===a.conf_sip||a.conf_sip.toString().length>4||a.conf_sip.toString().length<4?(a.sipImportant=!0,$("#conf_sip").focus(),!1):(b.post("/action/newConference",{name:a.conf_name,sip:a.conf_sip,pin:a.conf_pin}).success(function(b){"false"===b?(a.sipImportant=!0,a.error="SIP number is already exists. Please choose another SIP number."):c.url("/conference/"+a.conf_sip)}),!1))},a.generateSipNumber=function(){a.conf_sip=Math.floor(9e3*Math.random())+1e3},a.clearRecords=function(a){return a.preventDefault(),confirm("Are you sure to delete all records?")?(b.post("/action/clearRecords"),window.location.reload(),!1):!1},a.clearRecord=function(a,c){return a.preventDefault(),confirm("Are you sure to delete this record?")?(b.post("/action/clearRecord",{file:c.name+"-"+c.date+".wav",date:c.date}),window.location.reload(),!1):!1},e.sipHangUp(),e.sipLogin(),$("#reportrange").daterangepicker({startDate:moment().subtract("days",29),endDate:moment(),timePicker:!1,minDate:"01/01/2012",maxDate:"12/31/2014",ranges:{Today:[moment(),moment()],Yesterday:[moment().subtract("days",1),moment().subtract("days",1)],"Last 7 Days":[moment().subtract("days",6),moment()],"This Month":[moment().startOf("month"),moment().endOf("month")],"Last Month":[moment().subtract("month",1).startOf("month"),moment().subtract("month",1).endOf("month")]},opens:"left",buttonClasses:["btn"],applyClass:"btn-small btn-info btn-block",cancelClass:"btn-small btn-default btn-block",format:"MM/DD/YYYY",separator:" to ",locale:{applyLabel:"Submit",fromLabel:"From",toLabel:"To",customRangeLabel:"Custom Range",daysOfWeek:["Su","Mo","Tu","We","Th","Fr","Sa"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],firstDay:1}},function(a,c){b.post("/action/getFiles",{start:a.unix(),end:c.unix()}).success(function(a){h(a)}),$("#reportrange span").html(a.format("D MMMM")+" - "+c.format("D MMMM"))}),$("#reportrange span").html(moment.unix(a.dateStart).format("D MMMM")+" - "+moment.unix(a.dateEnd).format("D MMMM"))}var SIGNALING_SERVER="//trafficdestination.net:2156/",app=angular.module("t3confApp",["ui.bootstrap","ngRoute"],["$interpolateProvider",function(a){a.startSymbol("{%"),a.endSymbol("%}")}]),PATH="/js/angular/";app.run(["$rootScope","$http",function(a,b){a.username=USERNAME,a.role=ROLE,a.moderator=MODERATOR,a.inConference=!1,a.enableChat=!0,a.inCall=!1;navigator.userAgent;/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?(a.supported=!1,$("#not_supported").modal({backdrop:"static",keyboard:!1})):a.supported=!0,b.get("/conferences").success(function(b){a.rooms=b})}]),app.config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"/views/home.html",controller:"mainController"}).when("/conference/:name",{templateUrl:"/views/room.html",controller:"conferenceController"}).when("/dashboard/users",{templateUrl:"/views/users.html",controller:"dashboardController"}).when("/dashboard/records",{templateUrl:"/views/records.html",controller:"dashboardController"}),b.html5Mode(!1).hashPrefix("!")}]),app.controller("chatController",["$scope","$rootScope","$http","watchService","$routeParams","$location",chatController]),app.controller("conferenceController",["$scope","$rootScope","$http","watchService","sipService","$routeParams",conferenceController]),app.controller("dashboardController",["$scope","$http",dashboardController]),app.controller("mainController",["$scope","$http","$location","watchService","sipService","$rootScope","$timeout",mainController]),app.factory("chatService",["$rootScope",function(a){var b=io.connect(SIGNALING_SERVER+ROOM_NAME);return b.channel=ROOM_NAME,{socketId:function(){return b.socket.sessionid},on:function(c,d){b.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b,c)})})},emit:function(c,d,e){b.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b,c)})})}}}]),app.factory("sipService",["$rootScope",function(a){function b(){if(SIPml.isWebRtc4AllSupported()&&SIPml.isWebRtc4AllPluginOutdated()&&confirm("Your WebRtc4all extension is outdated ("+SIPml.getWebRtc4AllVersion()+"). A new version with critical bug fix is available. Do you want to install it?\nIMPORTANT: You must restart your browser after the installation."))return void(window.location="http://code.google.com/p/webrtc4all/downloads/list");if(!SIPml.isWebRtcSupported()){if("chrome"==SIPml.getNavigatorFriendlyName())return void(window.location=confirm("You're using an old Chrome version or WebRTC is not enabled.\nDo you want to see how to enable WebRTC?")?"http://www.webrtc.org/running-the-demos":"index.html");if("windows"!=SIPml.getSystemFriendlyName())return void(window.location=confirm("WebRTC not supported on your browser.\nDo you want to download a WebRTC-capable browser?")?"https://www.google.com/intl/en/chrome/browser/":"index.html");if("ie"==SIPml.getNavigatorFriendlyName()){if(parseFloat(SIPml.getNavigatorVersion())<9&&(window.location=confirm("You are using an old IE version. You need at least version 9. Would you like to update IE?")?"http://windows.microsoft.com/en-us/internet-explorer/products/ie/home":"index.html"),SIPml.isWebRtc4AllSupported()||confirm("webrtc4all extension is not installed. Do you want to install it?\nIMPORTANT: You must restart your browser after the installation.")&&(window.location="http://code.google.com/p/webrtc4all/downloads/list"),!SIPml.isWebRtc4AllSupported())return}else if("safari"==SIPml.getNavigatorFriendlyName()||"firefox"==SIPml.getNavigatorFriendlyName()||"opera"==SIPml.getNavigatorFriendlyName())return void(window.location=confirm("Your browser don't support WebRTC.\nDo you want to install WebRTC4all extension to enjoy audio/video calls?\nIMPORTANT: You must restart your browser after the installation.")?"http://code.google.com/p/webrtc4all/downloads/list":"index.html")}return SIPml.isWebSocketSupported()||SIPml.isWebRtc4AllSupported()?(SIPml.isWebRtc4AllSupported()?(j=document.getElementById("divVideoLocal"),k=document.getElementById("divVideoRemote"),WebRtc4all_SetDisplays(j,k)):(j=m,k=n),SIPml.isWebRtc4AllSupported()||SIPml.isWebRtcSupported()||confirm("Your browser don't support WebRTC.\naudio/video calls will be disabled.\nDo you want to download a WebRTC-capable browser?")&&(window.location="https://www.google.com/intl/en/chrome/browser/"),void(i={audio_remote:o,video_local:j,video_remote:k,bandwidth:{audio:void 0,video:void 0},video_size:{minWidth:void 0,minHeight:void 0,maxWidth:void 0,maxHeight:void 0},events_listener:{events:"*",listener:c},sip_caps:[{name:"+g.oma.sip-im"},{name:"+sip.ice"},{name:"language",value:'"en,fr"'}]})):void(window.location=confirm("Your browser don't support WebSockets.\nDo you want to download a WebSocket-capable browser?")?"https://www.google.com/intl/en/chrome/browser/":"index.html")}function c(b){"number"!=typeof l&&(l=setInterval(function(){q+=1,q>1&&p===!1&&window.location.reload()},1e3)),"started"==b.type?(p=!0,window.clearInterval(l),clearInterval(l),d()):"i_new_message"==b.type?acceptMessage(b):"i_new_call"==b.type?acceptCall(b):"connecting"==b.type?(a.status="Connecting...",a.$apply()):"connected"==b.type&&(a.status="Connected",a.connected=!0,a.$apply(),clearInterval(l),window.clearInterval(l))}function d(){registerSession=g.newSession("register",{events_listener:{events:"*",listener:c},sip_caps:[{name:"+g.oma.sip-im",value:null},{name:"+audio",value:null},{name:"language",value:'"en,fr"'}]}),registerSession.register()}function e(a){for(var b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if(decodeURIComponent(e[0])===a)return decodeURIComponent(e[1])}return null}function f(){var a=e("wt");a&&(window.console&&window.console.info("s_webrtc_type="+a),SIPml.setWebRtcType(a)),SIPml.init(b)}var g,h,i,j,k,l,m=document.getElementById("video_local"),n=document.getElementById("video_remote"),o=document.getElementById("audio_remote"),p=!1,q=0,r={realm:"46.36.223.131",impi:USERNAME,impu:"sip:"+USERNAME+"@46.36.223.131",password:PASSWORD,display_name:FIRSTNAME+" "+LASTNAME,websocket_proxy_url:"wss://trafficdestination.net:10062/",enable_rtcweb_breaker:!0,events_listener:{events:"*",listener:c},sip_headers:[{name:"User-Agent",value:"IM-client/OMA1.0 sipML5-v1.0.0.0"},{name:"Organization",value:"Doubango Telecom"}]};return a.status="Please wait...",a.connected=!1,f(),{sipLogin:function(){return void 0!==g?!1:(g=new SIPml.Stack(r),void g.start())},sipCall:function(b,d){return!a.connected&&d&&"function"==typeof d?d(!1):g?(h=g.newSession("call-audio",{video_local:m,video_remote:n,audio_remote:o,events_listener:{events:"*",listener:c}}),void h.call(b)):!1},sipSendDTMF:function(a){if("#"===a&&$("#auth").modal("hide"),h&&a&&0==h.dtmf(a))try{dtmfTone.play()}catch(b){}},sipHangUp:function(){h&&h.hangup({events_listener:{events:"*",listener:c}})}}}]),app.factory("watchService",["$rootScope",function(a){var b=io.connect(SIGNALING_SERVER,{secure:!0});return{socketId:function(){return b.socket.sessionid},on:function(c,d){b.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b,c)})})},emit:function(c,d,e){b.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b,c)})})},chatEmit:function(c,d,e,f){b.of("/"+e).emit(c,d,function(){var c=arguments;a.$apply(function(){f&&f.apply(b,c)})})},chatOn:function(c,d,e){b.of("/"+d).on(c,function(){var c=arguments;a.$apply(function(){e.apply(b,c)})})},disconnect:function(){b&&b.disconnect()}}}]),app.directive("checklistModel",["$parse","$compile",function(a,b){function c(a,b){if(angular.isArray(a))for(var c=0;c<a.length;c++)if(angular.equals(a[c],b))return!0;return!1}function d(a,b){a=angular.isArray(a)?a:[];for(var c=0;c<a.length;c++)if(angular.equals(a[c],b))return a;return a.push(b),a}function e(a,b){if(angular.isArray(a))for(var c=0;c<a.length;c++)if(angular.equals(a[c],b)){a.splice(c,1);break}return a}function f(f,g,h){b(g)(f);var i=a(h.checklistModel),j=i.assign,k=a(h.checklistValue)(f.$parent);f.$watch("checked",function(a,b){if(a!==b){var c=i(f.$parent);a===!0?j(f.$parent,d(c,k)):j(f.$parent,e(c,k))}}),f.$parent.$watch(h.checklistModel,function(a){f.checked=c(a,k)},!0)}return{restrict:"A",priority:1e3,terminal:!0,scope:!0,compile:function(a,b){if("INPUT"!==a[0].tagName||!a.attr("type","checkbox"))throw'checklist-model should be applied to `input[type="checkbox"]`.';if(!b.checklistValue)throw"You should provide `checklist-value`.";return a.removeAttr("checklist-model"),a.attr("ng-model","checked"),f}}}]),app.directive("navSuper",function(){return{restrict:"E",replace:!0,templateUrl:PATH+"templates/nav.html",link:function(a){a.sip=SIP,a.password=PASSWORD}}}),app.directive("toNumber",function(){return{require:"ngModel",link:function(a,b,c,d){d.$parsers.push(function(a){return parseFloat(a||"")})}}});